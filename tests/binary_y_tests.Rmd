---
title: "Tests binary Y works"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, echo=FALSE, results="hide", warning=FALSE, message=FALSE}
source(here::here("vignettes/setup_sims.R"))
devtools::load_all()
# remotes::install_github("pedrohcgs/DRDID")
library(BMisc)
library(ggplot2)
library(gridExtra)
library(tidyverse)

ncl <- 1
time.periods <- 4
biters <- 200
```



```{r}
# Creates simulation params
sim_params = did::reset.sim(time.periods = 20, n = 100)

sim_df = did::build_sim_dataset(sp_list = sim_params, panel = TRUE) %>%
    as_tibble()

library(tidyverse)

sim_df %>%
    summarise(across(c(G, id, period), n_distinct))

binary_sim_df = sim_df %>%
    group_by(G) %>%
    mutate(Y_above = Y > quantile(Y, 0.15)) %>%
    ungroup() %>%
    group_by(id) %>%
    mutate(
        first_Y =  min(period[Y_above == TRUE])
    ) %>%
    mutate(Y_binary = period >= first_Y)


binary_sim_df %>%
    group_by(period, G) %>%
    summarise(n_outcome = sum(Y_binary)) %>%
    ggplot(aes(
        x = period, 
        y = n_outcome, 
        colour = factor(G)
    )) +
    geom_line()

devtools::load_all()
cs_fit = att_gt(
    binary_sim_df,
    yname = "Y_binary",
    tname = "period",
    gname = "G",
    idname = "id",
    xformla = ~1, 
    print_details = TRUE,
    # base_period = "varying",
    control_group = "notyettreated" )


cs_fit

library(data.table)

df = as.data.table(binary_sim_df)


calc_expectation = function(df){
    # N.B. will impute first time period - 1 so don't include very first time period (CS drop this automatically) 
    if (nrow(df[Y_binary == TRUE]) == 0){
        expectation = 0
    } else {
        expectation = df[Y_binary == TRUE, n]/sum(df[, n])
    }
    return(expectation)
}

att_g_t = function(df, t, g, verbose = FALSE){
    if (t >= g) {
        y_t_treated = df[G == g & period == t, .(n = .N, g = g, t = g), by = Y_binary]
        y_gm1_treated = df[G == g & period == g - 1, .(n = .N, g = g, t = g), by = Y_binary]

        # are you treated by period t
        y_t_nyt = df[(t < G | G == 0) & period == t, .(n = .N, g = g, t = g), by = Y_binary]
        y_gm1_nyt = df[(t < G | G == 0) & period == g-1, .(n = .N, g = g, t = g), by = Y_binary]
    }
    
    if (t < g) {
        y_t_treated = df[G == g & period == t, .(n = .N, g = g, t = g), by = Y_binary]
        y_gm1_treated = df[G == g & period == t - 1, .(n = .N, g = g, t = g), by = Y_binary]
        
        y_t_nyt = df[period == t & G != g & (G > t | G == 0), .(n = .N, g = g, t = g), by = Y_binary]
        y_gm1_nyt = df[period == t -1 & G != g & (G > t | G == 0), .(n = .N, g = g, t = g), by = Y_binary]
    }


    e_y_t_treated = calc_expectation(y_t_treated)
    e_y_gm1_treated = calc_expectation(y_gm1_treated)

    e_y_t_nyt = calc_expectation(y_t_nyt)
    e_y_gm1_nyt = calc_expectation(y_gm1_nyt)

    treat_diff = e_y_t_treated - e_y_gm1_treated
    control_diff = e_y_t_nyt - e_y_gm1_nyt

    att_g_t = treat_diff - control_diff
    if (verbose == TRUE) {
        return(lst(
            att_g_t, 
            g, 
            t, 
            y_t_treated, 
            y_gm1_treated, 
            y_t_nyt,
            y_gm1_nyt))
    }
    return(lst(att_g_t, g, t))
}

gs_and_ts = tidy(cs_fit) %>%
    select(G = group, period = time) %>%
    unique() %>%
    as_tibble()

    

manual_fit = map2_dfr(
    gs_and_ts$G,
    gs_and_ts$period,
    ~att_g_t(df, g = .x, t = .y)
) %>%
    rename(estimate = att_g_t, group = g, time = t)

tidy_cs_fit = cs_fit %>%
    tidy() %>%
    as_tibble()




wide_comp_df = inner_join(
    tidy_cs_fit %>%
        rename(cs_estimate = estimate), 
    manual_fit  %>% rename(manual_estimate = estimate),
        by = c("group", "time")
)


wide_comp_df %>%
    ggplot(aes(
        x = cs_estimate,
        y = manual_estimate
    )) +
    geom_point() +
    geom_abline(linetype = "longdash") +
    theme_bw()

max_error = wide_comp_df %>%
    mutate(error = abs(manual_estimate - cs_estimate)) %>%
    summarise(max_error = max(error)) %>%
    pull()


if (max_error > 1e-8) {
    stop("Manual Estimates Off")
}

comp_df = bind_rows(
    manual_fit  %>% mutate(type = "manual"),
    tidy(cs_fit) %>%
        as_tibble() %>%
        select(estimate, group, time) %>%
        mutate(type = "cs")
)



```


## Survival Process Stuff

```{r}



att_g_t(df, 6, 3, verbose = TRUE)


df[G == 6]

test_df = df[G == 6, .(first_Y = unique(first_Y), G = unique(G)), id]
test_df

att_g_t(df, 9, 6, verbose = TRUE)




create_indiv_first_treat_dt = function(dt, y_var, group_var, id_var) {
    summ_dt = dt[
        , 
        .(
            first_Y = unique(get(y_var)),
            G = unique(get(group_var))
        ), 
        by = id_var
        ]
    return(summ_dt)
}


create_group_first_treat_dt = function(dt, y_var, group_var, t_levels, group_levels) {
    summ_group_dt = dt[, .N, by = c(y_var, group_var)][, t := get(y_var)]
    
    
    zero_t_group_dt = CJ(t = t_levels, group_var = group_levels, n_zero = 0)
    full_group_dt = merge(
        summ_group_dt,
        zero_t_group_dt,
        by.x = c("t", group_var),
        by.y = c("t", "group_var"), 
        all.y = TRUE
    )
    full_group_dt[is.na(N), N := n_zero]
    full_group_dt[, n_zero := NULL]
    full_cumsum_group_dt = full_group_dt[
        order(get(group_var), t),
        .(n = cumsum(N), t = unique(t)),
        group_var
    ]
    setcolorder(full_cumsum_group_dt, c(group_var, "t", "n"))
    full_cumsum_group_dt[, n_lag := shift(n), by = G]
    return(full_cumsum_group_dt)
}

create_indiv_per_period_dt = function(df, group_var, t_var, t_levels, group_levels) {
    empty_dt = CJ(G = group_levels, t = t_levels, N_0 = 0 )
    n_indiv = df[, .N, by = c(group_var, t_var)]

    full_dt = merge(
        empty_dt,
        n_indiv,
        all.x = TRUE, 
        by.y = c(group_var, t_var), 
        by.x = c("G", "t")
    )

    full_dt[is.na(N), N := N_0]
    full_dt[, N_0 := NULL]
    full_dt[, N_lag := shift(N), by = group_var]
    return(full_dt)
}

N_indiv_dt = create_indiv_per_period_dt(df, "G", "period", c(1:20, Inf), unique(df$G))
summ_indiv_dt = create_indiv_first_treat_dt(df, "first_Y", "G", "id")
summ_group_dt = create_group_first_treat_dt(
    summ_indiv_dt, 
    "first_Y", 
    "G", 
    c(1:20, Inf), 
    unique(summ_indiv_dt$G))


ed_calculate_att_g_t = function(g_val, t_val, lookup_table, N_table, verbose = FALSE) {
    if (t_val >= g_val) {
        lag_t_val = g_val - 1
    } else {
        lag_t_val = t_val - 1
    }
    n_g_t_treated = lookup_table[t == t_val & G == g_val, n] 
    N_g_t = N_table[t == t_val & G == g_val, N]
    y_g_t_treated  = n_g_t_treated /  N_g_t

    n_g_gm1_treated = lookup_table[t == lag_t_val & G == g_val, n] 
    N_g_gm1 = N_table[t == lag_t_val & G == g_val, N]
    y_g_gm1_treated = n_g_gm1_treated / N_g_gm1

    n_g_t_nyt = lookup_table[t == t_val & G != g_val & (t_val < G | G == 0)][, sum(n)] 
    N_g_t_nyt = N_table[t == t_val & G != g_val & (t_val < G | G == 0)][, sum(N)]
    y_g_t_nyt = n_g_t_nyt / N_g_t_nyt


    n_g_gm1_nyt = lookup_table[t == lag_t_val & G != g_val & (t_val < G | G == 0)][, sum(n)] 
    N_g_gm1_nyt = N_table[t == lag_t_val & G != g_val & (t_val < G | G == 0)][, sum(N)]
    y_g_gm1_nyt = n_g_gm1_nyt / N_g_gm1_nyt

    att_g_t = (y_g_t_treated - y_g_gm1_treated) - (y_g_t_nyt - y_g_gm1_nyt)
    if (verbose == TRUE) {
        return(lst(
            n_g_t_treated, 
            N_g_t,
            n_g_gm1_treated,
            N_g_gm1,
            n_g_t_nyt,
            N_g_t_nyt,
            n_g_gm1_nyt, 
            N_g_gm1_nyt,
            att_g_t
            ))
    }
    return(lst(g = g_val, t = t_val, att_g_t))
}


lookup_manual_fit = map2_dfr(
    gs_and_ts$G,
    gs_and_ts$period,
    ~ed_calculate_att_g_t(g_val = .x, t_val = .y, lookup_table = summ_group_dt, N_table = N_indiv_dt)
) 



wide_lookup_comp_df = inner_join(
    lookup_manual_fit %>% rename(manual_estimate = att_g_t),
    tidy_cs_fit %>%
        select(group, time, cs_estimate = estimate), 
    by = c("g" = "group", "t" = "time")
)



wide_lookup_comp_df %>%
    ggplot(aes(
        x = cs_estimate,
        y = manual_estimate
    )) +
    geom_point() +
    geom_abline(linetype = "longdash") +
    theme_bw()

lookup_max_error = wide_lookup_comp_df %>%
    mutate(error = abs(manual_estimate - cs_estimate)) %>%
    summarise(max_error = max(error)) %>%
    pull()


if (lookup_max_error > 1e-8) {
    stop("Manual Estimates Off")
}



```



```{r}
# Profiling Stuff
microbenchmark::microbenchmark(
    map2_dfr(
    gs_and_ts$G,
    gs_and_ts$period,
    ~att_g_t(df, g = .x, t = .y)
) %>%
    rename(estimate = att_g_t, group = g, time = t),
    att_gt(
    binary_sim_df,
    yname = "Y_binary",
    tname = "period",
    gname = "G",
    idname = "id",
    xformla = ~1, 
    print_details = TRUE,
    base_period = "varying",
    control_group = "notyettreated" ),
    times = 1
)


profvis(
    {
    manual_fit = map2_dfr(
        gs_and_ts$G,
        gs_and_ts$period,
        ~att_g_t(df, g = .x, t = .y)
    ) %>%
        rename(estimate = att_g_t, group = g, time = t)
    }
)


```