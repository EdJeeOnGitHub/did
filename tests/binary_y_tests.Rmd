---
title: "Tests binary Y works"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, echo=FALSE, results="hide", warning=FALSE, message=FALSE}
source(here::here("vignettes/setup_sims.R"))
devtools::load_all()
# remotes::install_github("pedrohcgs/DRDID")
library(BMisc)
library(data.table)
library(ggplot2)
library(gridExtra)
library(tidyverse)
library(furrr)

ncl <- 1
time.periods <- 4
biters <- 200
```



```{r}
# Creates simulation params
sim_params = did::reset.sim(time.periods = 20, n = 1000)

sim_df = did::build_sim_dataset(sp_list = sim_params, panel = TRUE) %>%
    as_tibble()

library(tidyverse)

sim_df %>%
    summarise(across(c(G, id, period), n_distinct))

binary_sim_df = sim_df %>%
    group_by(G) %>%
    mutate(Y_above = Y > quantile(Y, 0.15)) %>%
    ungroup() %>%
    group_by(id) %>%
    mutate(
        first_Y =  min(period[Y_above == TRUE])
    ) %>%
    mutate(Y_binary = period >= first_Y)


binary_sim_df %>%
    group_by(period, G) %>%
    summarise(n_outcome = sum(Y_binary)) %>%
    ggplot(aes(
        x = period, 
        y = n_outcome, 
        colour = factor(G)
    )) +
    geom_line()

devtools::load_all()
cs_fit = att_gt(
    binary_sim_df,
    yname = "Y_binary",
    tname = "period",
    gname = "G",
    idname = "id",
    xformla = ~1, 
    print_details = TRUE,
    # base_period = "varying",
    control_group = "notyettreated" )


cs_fit

library(data.table)

df = as.data.table(binary_sim_df)


calc_expectation = function(df){
    # N.B. will impute first time period - 1 so don't include very first time period (CS drop this automatically) 
    if (nrow(df[Y_binary == TRUE]) == 0){
        expectation = 0
    } else {
        expectation = df[Y_binary == TRUE, n]/sum(df[, n])
    }
    return(expectation)
}

att_g_t = function(df, t, g, verbose = FALSE){
    if (t >= g) {
        y_t_treated = df[G == g & period == t, .(n = .N, g = g, t = g), by = Y_binary]
        y_gm1_treated = df[G == g & period == g - 1, .(n = .N, g = g, t = g), by = Y_binary]

        # are you treated by period t
        y_t_nyt = df[(t < G | G == 0) & period == t, .(n = .N, g = g, t = g), by = Y_binary]
        y_gm1_nyt = df[(t < G | G == 0) & period == g-1, .(n = .N, g = g, t = g), by = Y_binary]
    }
    
    if (t < g) {
        y_t_treated = df[G == g & period == t, .(n = .N, g = g, t = g), by = Y_binary]
        y_gm1_treated = df[G == g & period == t - 1, .(n = .N, g = g, t = g), by = Y_binary]
        
        y_t_nyt = df[period == t & G != g & (G > t | G == 0), .(n = .N, g = g, t = g), by = Y_binary]
        y_gm1_nyt = df[period == t -1 & G != g & (G > t | G == 0), .(n = .N, g = g, t = g), by = Y_binary]
    }


    e_y_t_treated = calc_expectation(y_t_treated)
    e_y_gm1_treated = calc_expectation(y_gm1_treated)

    e_y_t_nyt = calc_expectation(y_t_nyt)
    e_y_gm1_nyt = calc_expectation(y_gm1_nyt)

    treat_diff = e_y_t_treated - e_y_gm1_treated
    control_diff = e_y_t_nyt - e_y_gm1_nyt

    att_g_t = treat_diff - control_diff
    if (verbose == TRUE) {
        return(lst(
            att_g_t, 
            g, 
            t, 
            y_t_treated, 
            y_gm1_treated, 
            y_t_nyt,
            y_gm1_nyt))
    }
    return(lst(att_g_t, g, t))
}

gs_and_ts = tidy(cs_fit) %>%
    select(G = group, period = time) %>%
    unique() %>%
    as_tibble()

    

manual_fit = map2_dfr(
    gs_and_ts$G,
    gs_and_ts$period,
    ~att_g_t(df, g = .x, t = .y)
) %>%
    rename(estimate = att_g_t, group = g, time = t)

tidy_cs_fit = cs_fit %>%
    tidy() %>%
    as_tibble()




wide_comp_df = inner_join(
    tidy_cs_fit %>%
        rename(cs_estimate = estimate), 
    manual_fit  %>% rename(manual_estimate = estimate),
        by = c("group", "time")
)


wide_comp_df %>%
    ggplot(aes(
        x = cs_estimate,
        y = manual_estimate
    )) +
    geom_point() +
    geom_abline(linetype = "longdash") +
    theme_bw()

max_error = wide_comp_df %>%
    mutate(error = abs(manual_estimate - cs_estimate)) %>%
    summarise(max_error = max(error)) %>%
    pull()


if (max_error > 1e-8) {
    stop("Manual Estimates Off")
}

comp_df = bind_rows(
    manual_fit  %>% mutate(type = "manual"),
    tidy(cs_fit) %>%
        as_tibble() %>%
        select(estimate, group, time) %>%
        mutate(type = "cs")
)



```


## Survival Process Stuff

```{r}



N_indiv_dt = create_indiv_per_period_dt(df, "G", "period", c(1:20, Inf), unique(df$G))
summ_indiv_dt = create_indiv_first_treat_dt(df, "first_Y", "G", "id")
summ_group_dt = create_group_first_treat_dt(
    summ_indiv_dt, 
    "first_Y", 
    "G", 
    c(1:20, Inf), 
    unique(summ_indiv_dt$G))

lookup_manual_fit = map2_dfr(
    gs_and_ts$G,
    gs_and_ts$period,
    ~calculate_att_g_t(g_val = .x, t_val = .y, lookup_table = summ_group_dt, N_table = N_indiv_dt)
) 
manual_did = estimate_did(data = df, y_var = "first_Y", group_var = 'G', t_var = "period", id_var = "id" )


wide_lookup_comp_df = inner_join(
    manual_did %>% rename(manual_estimate = att_g_t),
    tidy_cs_fit %>%
        select(group, time, cs_estimate = estimate), 
    by = c("group","time")
)


wide_lookup_comp_df %>%
    ggplot(aes(
        x = cs_estimate,
        y = manual_estimate
    )) +
    geom_point() +
    geom_abline(linetype = "longdash") +
    theme_bw()

lookup_max_error = wide_lookup_comp_df %>%
    mutate(error = abs(manual_estimate - cs_estimate)) %>%
    summarise(max_error = max(error)) %>%
    pull()


if (lookup_max_error > 1e-8) {
    stop("Manual Estimates Off")
}



```

### Bootstrap SEs


```{r}

manual_es = manual_did %>%
    group_by(
        event.time
    ) %>%
    mutate(
        wt = pr/sum(pr)
    ) %>%
    summarise(
        estimate = sum(wt*att_g_t)
    )

cs_es = aggte(cs_fit, type = "dynamic")
tidy_cs_es = tidy(cs_es) %>% as_tibble()

comp_es = bind_rows(
    manual_es %>% mutate(type = "manual"),
    tidy_cs_es %>% mutate(type = "cs")
)

n_es_no_match = comp_es %>%
    select(
        event.time, 
        estimate, 
        type
    ) %>%
    spread(
        type, estimate
    ) %>%
    mutate(diff = abs(cs - manual)) %>%
    dplyr::filter(diff > 1e-6 ) %>%
    nrow()

if (n_es_no_match > 0) {
    stop("Event study estimates don't match")
}

library(furrr)
plan(multicore, workers = 16)

manual_boot_att_gt = bootstrap_did(
    df = df, 
    y_var = "first_Y", 
    group_var = 'G', 
    t_var = "period", 
    id_var = "id" ,
    B_draws = 100)

manual_boot_es = manual_boot_att_gt %>%
    group_by(B_draw) %>%
    group_split() %>%
    map_dfr(calculate_event_study, .id = "B_draw")

resid_boot_att_gt = merge(
    manual_boot_att_gt,
    manual_did[, .(group, time, orig_att_g_t = att_g_t)],
    all.x = TRUE,
    by = c("group", "time")
)
n_total = df[, uniqueN(id)]
resid_boot_att_gt[, resid := sqrt(n_total)*(orig_att_g_t - att_g_t)]
manual_att_se = resid_boot_att_gt[
    , 
    .(
        std.error = (quantile(resid, 0.75) - quantile(resid, 0.25))/(qnorm(0.75) - qnorm(0.25)), 
        estimate = unique(orig_att_g_t)
        ), 
    .(group, time)
    ]

bind_rows(
    manual_att_se %>% mutate(type = "manual"), 
    tidy_cs_fit %>% mutate(type = "cs")
) %>%
    select( 
        group, 
        time, 
        estimate, 
        std.error, 
        type
    ) %>%
    select(-estimate) %>%
    spread(
        type, std.error
    )  %>%
    as_tibble() %>%
    ggplot(aes(
        x = cs, 
        y = manual
    )) +
    geom_point() +
    geom_abline()


manual_es_se = manual_boot_es %>%
    group_by(
        event.time
    ) %>%
    summarise(
        conf.low = quantile(estimate, 0.025, na.rm = TRUE), 
        conf.high = quantile(estimate, 0.975, na.rm = TRUE)
    )  %>%
    left_join(
        manual_es, 
        by = "event.time"
    ) 

comp_es_se = bind_rows(
    manual_es_se %>% mutate(type = "manual"),
    tidy_cs_es %>% 
        select(estimate, conf.low = point.conf.low, conf.high = point.conf.high, event.time) %>%
        mutate(type = "cs")
)


comp_es_se %>%
    ggplot(aes(
        x = event.time, 
        y = estimate, 
        ymin = conf.low, 
        ymax = conf.high, 
        colour = type
    )) +
    geom_pointrange(
        position = position_dodge(0.5)
    )
manual_es_se

tidy_cs_es

manual_boot_es %>%
    group_by(
        event.time
    ) %>%
    summarise(
        conf.low = quantile(estimate, 0.025), 
        conf.high = quantile(estimate, 0.975)
    )  %>%
    left_join(
        manual_es
    ) %>%
    ggplot(aes(
        x = event.time, 
        y = estimate,
        ymin = conf.low,
        ymax = conf.high
    )) +
    geom_pointrange()


bind_rows(manual_boot_es) %>%
    ggplot(aes(
        x = event.time,
        y = estimate
    )) +
    geom_point


    


```


```{r}
# Profiling Stuff
mb_results = microbenchmark::microbenchmark(
#     manual_binary = map2_dfr(
#     gs_and_ts$G,
#     gs_and_ts$period,
#     ~att_g_t(df, g = .x, t = .y)
# ) %>%
#     rename(estimate = att_g_t, group = g, time = t),
    manual_did = estimate_did(data = df, y_var = "first_Y", group_var = 'G', t_var = "period", id_var = "id" ),
    # cs = att_gt(
    # binary_sim_df,
    # yname = "Y_binary",
    # tname = "period",
    # gname = "G",
    # idname = "id",
    # xformla = ~1, 
    # base_period = "varying",
    # control_group = "notyettreated" ),
    times = 20
)



profvis::profvis(
    {
    manual_did = estimate_did(data = df, y_var = "first_Y", group_var = 'G', t_var = "period", id_var = "id" )
    }
)


```