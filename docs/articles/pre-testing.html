<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pre-Testing in a DID Setup using the did Package • did</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Pre-Testing in a DID Setup using the did Package">
<meta property="og:description" content="did">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">did</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/index.html">User Guides</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Pre-Testing in a DID Setup using the did Package</h1>
                        <h4 class="author">Brantly Callaway and Pedro H.C. Sant'Anna</h4>
            
            <h4 class="date">2020-07-04</h4>
      
      
      <div class="hidden name"><code>pre-testing.Rmd</code></div>

    </div>

    
    
<p>Another very appealing feature of many DID applications with multiple periods is that the researcher can pre-test the parallel trends assumptions.</p>
<p>The idea here is simple: although one can not test whether parallel trends itself holds, one can check if it holds in periods before treated units actually become treated.</p>
<p>Importantly, this is just a pre-test; it is different from an actual test. Whether or not the parallel trends assumption holds in pre-treatment periods does not actually tell you if it holds in the current period (and this is when you need it to hold!). It is certainly possible for the identifying assumptions to hold in previous periods but not hold in current periods; it is also possible for identifying assumptions to be violated in previous periods but for them to hold in current periods. That being said, the right way to think about a pre-test is as (potentially strong) piece of evidence on the validity of the DID design in a particular application.</p>
<div id="common-approaches-to-pre-testing-in-applications" class="section level2">
<h2 class="hasAnchor">
<a href="#common-approaches-to-pre-testing-in-applications" class="anchor"></a>Common Approaches to Pre-Testing in Applications</h2>
<p>By far the most common approach to pre-testing in applications is to run an <strong>event-study regression</strong>. Here, the idea is to run a regression that includes leads and lags of the treatment dummy variable such as <span class="math display">\[
  Y_{it} = \theta_t + \eta_i + \sum_{l=-\mathcal{T}}^{\mathcal{T}-1} D_{it}^l \mu_l + v_{it}
\]</span></p>
<p>where <span class="math inline">\(D_{it}^l = 1\)</span> if individual <span class="math inline">\(i\)</span> has been exposed to the treatment for <span class="math inline">\(l\)</span> periods in period <span class="math inline">\(t\)</span>, and <span class="math inline">\(D_{it}^l = 0\)</span> otherwise. To be clear here, it is helpul to give some examples. Suppose individual <span class="math inline">\(i\)</span> becomes treated in period 3. Then,</p>
<ul>
<li><p><span class="math inline">\(D_{it}^0 = 1\)</span> when <span class="math inline">\(t=3\)</span> and is equal to 0 in other time periods</p></li>
<li><p><span class="math inline">\(D_{it}^2 = 1\)</span> when <span class="math inline">\(t=5\)</span> and is equal to 0 in other time periods</p></li>
<li><p><span class="math inline">\(D_{it}^{-2} = 1\)</span> when <span class="math inline">\(t=1\)</span> and is equal to 0 in other time periods.</p></li>
</ul>
<p>And <span class="math inline">\(\mu_l\)</span> is interpreted as the effect of treatment for different lengths of exposure to the treatment. Typically, <span class="math inline">\(\mu_{-1}\)</span> is normalized to be equal to 0, and we follow that convention here. It is very common to interpret estimated <span class="math inline">\(\mu_l\)</span>’s with <span class="math inline">\(l &lt; 0\)</span> as a way to pre-test the parallel trends assumption.</p>
<div id="pitfalls-with-event-study-regressions" class="section level3">
<h3 class="hasAnchor">
<a href="#pitfalls-with-event-study-regressions" class="anchor"></a>Pitfalls with Event Study Regressions</h3>
<div id="best-case-scenario-for-pre-testing" class="section level4">
<h4 class="hasAnchor">
<a href="#best-case-scenario-for-pre-testing" class="anchor"></a>Best Case Scenario for Pre-Testing</h4>
<p>First, let’s start with a case where an event study regression is going to work well for pre-testing the parallel trends assumption</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># generate dataset with 4 time periods</span>
<span class="no">time.periods</span> <span class="kw">&lt;-</span> <span class="fl">4</span>

<span class="co"># generate dynamic effects</span>
<span class="no">te.e</span> <span class="kw">&lt;-</span> <span class="no">time.periods</span>:<span class="fl">1</span>

<span class="co"># generate data set with these parameters</span>
<span class="co"># (main thing: it generates a dataset that satisfies</span>
<span class="co"># parallel trends in all periods...including pre-treatment)</span>
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu">build_sim_dataset</span>()

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">data</span>)
<span class="co">#&gt;       G        X id period         Y treat</span>
<span class="co">#&gt; 1     2 0.530541  1      1  4.264584     1</span>
<span class="co">#&gt; 8001  2 0.530541  1      2 10.159789     1</span>
<span class="co">#&gt; 16001 2 0.530541  1      3  9.482624     1</span>
<span class="co">#&gt; 24001 2 0.530541  1      4 10.288278     1</span>
<span class="co">#&gt; 2     4 1.123550  2      1  3.252148     1</span>
<span class="co">#&gt; 8002  4 1.123550  2      2  7.038382     1</span></pre></body></html></div>
<p>The main thing to notice here:</p>
<ul>
<li>The dynamics are common across all groups. This is the case where an event-study regression will work.</li>
</ul>
<p>Next, a bit more code</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co">#-----------------------------------------------------------------------------</span>
<span class="co"># modify the dataset a bit so that we can run an event study</span>
<span class="co">#-----------------------------------------------------------------------------</span>

<span class="co"># generate leads and lags of the treatment</span>
<span class="no">Dtl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(-(<span class="no">time.periods</span>-<span class="fl">1</span>):(<span class="no">time.periods</span>-<span class="fl">2</span>), <span class="kw">function</span>(<span class="no">l</span>) {
    <span class="no">dtl</span> <span class="kw">&lt;-</span> <span class="fl">1</span>*( (<span class="no">data</span>$<span class="no">period</span> <span class="kw">==</span> <span class="no">data</span>$<span class="no">G</span> + <span class="no">l</span>) <span class="kw">&amp;</span> (<span class="no">data</span>$<span class="no">G</span> <span class="kw">&gt;</span> <span class="fl">0</span>) )
    <span class="no">dtl</span>
})
<span class="no">Dtl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="no">Dtl</span>)
<span class="no">cnames1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Dtmin"</span>,(<span class="no">time.periods</span>-<span class="fl">1</span>):<span class="fl">1</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">Dtl</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">cnames1</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Dt"</span>,<span class="fl">0</span>:(<span class="no">time.periods</span>-<span class="fl">2</span>)))
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind.data.frame</a></span>(<span class="no">data</span>, <span class="no">Dtl</span>)
<span class="fu"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span>(<span class="no">data</span>) <span class="kw">&lt;-</span> <span class="kw">NULL</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">data</span>)
<span class="co">#&gt;   G        X id period         Y treat Dtmin3 Dtmin2 Dtmin1 Dt0 Dt1 Dt2</span>
<span class="co">#&gt; 1 2 0.530541  1      1  4.264584     1      0      0      1   0   0   0</span>
<span class="co">#&gt; 2 2 0.530541  1      2 10.159789     1      0      0      0   1   0   0</span>
<span class="co">#&gt; 3 2 0.530541  1      3  9.482624     1      0      0      0   0   1   0</span>
<span class="co">#&gt; 4 2 0.530541  1      4 10.288278     1      0      0      0   0   0   1</span>
<span class="co">#&gt; 5 4 1.123550  2      1  3.252148     1      1      0      0   0   0   0</span>
<span class="co">#&gt; 6 4 1.123550  2      2  7.038382     1      0      1      0   0   0   0</span>

<span class="co">#-----------------------------------------------------------------------------</span>
<span class="co"># run the event study regression</span>
<span class="co">#-----------------------------------------------------------------------------</span>

<span class="co"># load plm package</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">plm</span>)

<span class="co"># run event study regression</span>
<span class="co"># normalize effect to be 0 in pre-treatment period</span>
<span class="no">es</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plm/man/plm.html">plm</a></span>(<span class="no">Y</span> ~ <span class="no">Dtmin3</span> + <span class="no">Dtmin2</span> + <span class="no">Dt0</span> + <span class="no">Dt1</span> + <span class="no">Dt2</span>, <span class="kw">data</span><span class="kw">=</span><span class="no">data</span>, <span class="kw">model</span><span class="kw">=</span><span class="st">"within"</span>, <span class="kw">effect</span><span class="kw">=</span><span class="st">"twoways"</span>, <span class="kw">index</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"id"</span>,<span class="st">"period"</span>))

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">es</span>)
<span class="co">#&gt; Twoways effects Within Model</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; plm(formula = Y ~ Dtmin3 + Dtmin2 + Dt0 + Dt1 + Dt2, data = data, </span>
<span class="co">#&gt;     effect = "twoways", model = "within", index = c("id", "period"))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Balanced Panel: n = 6988, T = 4, N = 27952</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;       Min.    1st Qu.     Median    3rd Qu.       Max. </span>
<span class="co">#&gt; -9.8577453 -0.7594999  0.0066022  0.7639995 11.6570179 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;        Estimate Std. Error t-value Pr(&gt;|t|)    </span>
<span class="co">#&gt; Dtmin3 0.041851   0.070134  0.5967   0.5507    </span>
<span class="co">#&gt; Dtmin2 0.023539   0.050044  0.4704   0.6381    </span>
<span class="co">#&gt; Dt0    4.012515   0.043824 91.5602   &lt;2e-16 ***</span>
<span class="co">#&gt; Dt1    3.005615   0.054473 55.1767   &lt;2e-16 ***</span>
<span class="co">#&gt; Dt2    2.098672   0.077281 27.1565   &lt;2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Total Sum of Squares:    82617</span>
<span class="co">#&gt; Residual Sum of Squares: 55795</span>
<span class="co">#&gt; R-Squared:      0.32466</span>
<span class="co">#&gt; Adj. R-Squared: 0.099232</span>
<span class="co">#&gt; F-statistic: 2014.84 on 5 and 20956 DF, p-value: &lt; 2.22e-16</span>

<span class="co">#-----------------------------------------------------------------------------</span>
<span class="co"># make an event study plot</span>
<span class="co">#-----------------------------------------------------------------------------</span>

<span class="co"># some housekeeping for making the plot</span>
<span class="co"># add 0 at event time -1</span>
<span class="no">coefs1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">es</span>)
<span class="no">ses1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">es</span>)$<span class="no">vcov</span>))
<span class="no">idx.pre</span> <span class="kw">&lt;-</span> <span class="fl">1</span>:(<span class="no">time.periods</span>-<span class="fl">2</span>)
<span class="no">idx.post</span> <span class="kw">&lt;-</span> (<span class="no">time.periods</span>-<span class="fl">1</span>):<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">coefs1</span>)
<span class="no">coefs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">coefs1</span>[<span class="no">idx.pre</span>], <span class="fl">0</span>, <span class="no">coefs1</span>[<span class="no">idx.post</span>])
<span class="no">ses</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ses1</span>[<span class="no">idx.pre</span>], <span class="fl">0</span>, <span class="no">ses1</span>[<span class="no">idx.post</span>])
<span class="no">exposure</span> <span class="kw">&lt;-</span> -(<span class="no">time.periods</span>-<span class="fl">1</span>):(<span class="no">time.periods</span>-<span class="fl">2</span>)

<span class="no">cmat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">coefs</span><span class="kw">=</span><span class="no">coefs</span>, <span class="kw">ses</span><span class="kw">=</span><span class="no">ses</span>, <span class="kw">exposure</span><span class="kw">=</span><span class="no">exposure</span>)

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">gridExtra</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span><span class="kw">=</span><span class="no">cmat</span>, <span class="kw">mapping</span><span class="kw">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span><span class="kw">=</span><span class="no">coefs</span>, <span class="kw">x</span><span class="kw">=</span><span class="no">exposure</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">linetype</span><span class="kw">=</span><span class="st">"dashed"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">ymin</span><span class="kw">=</span>(<span class="no">coefs</span>-<span class="fl">1.96</span>*<span class="no">ses</span>), <span class="kw">ymax</span><span class="kw">=</span>(<span class="no">coefs</span>+<span class="fl">1.96</span>*<span class="no">ses</span>)), <span class="kw">width</span><span class="kw">=</span><span class="fl">0.2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">2</span>,<span class="fl">5</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</pre></body></html></div>
<p><img src="pre-testing_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>You will notice that everything looks good here. The pre-test performs well (the caveat to this is that the standard errors are “pointwise” and would be better to have uniform confidence bands though this does not seem to be standard practice in applications).</p>
<p>We can compare this to what happens using the <code>did</code> package:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># estimate group-group time average treatment effects</span>
<span class="no">did.att.gt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/att_gt.html">att_gt</a></span>(<span class="st">"Y"</span>, <span class="st">"period"</span>, <span class="st">"id"</span>, <span class="st">"G"</span>, <span class="kw">data</span><span class="kw">=</span><span class="no">data</span>,
                     <span class="kw">printdetails</span><span class="kw">=</span><span class="fl">FALSE</span>, <span class="kw">bstrap</span><span class="kw">=</span><span class="fl">FALSE</span>, <span class="kw">cband</span><span class="kw">=</span><span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">did.att.gt</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Reference: Callaway, Brantly and Sant'Anna, Pedro.  "Difference-in-Differences with Multiple Time Periods." Working Paper &lt;https://ssrn.com/abstract=3148250&gt;, 2019. </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  group   time          att          se</span>
<span class="co">#&gt; ------  -----  -----------  ----------</span>
<span class="co">#&gt;      2      2    4.0047961   0.0859163</span>
<span class="co">#&gt;      2      3    3.0651920   0.1129338</span>
<span class="co">#&gt;      2      4    2.1122999   0.1466261</span>
<span class="co">#&gt;      3      2   -0.0275928   0.0490521</span>
<span class="co">#&gt;      3      3    3.9992880   0.1033183</span>
<span class="co">#&gt;      3      4    2.9554333   0.1315381</span>
<span class="co">#&gt;      4      2   -0.0420415   0.0516402</span>
<span class="co">#&gt;      4      3    0.0015543   0.0490802</span>
<span class="co">#&gt;      4      4    4.0303982   0.1369432</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; P-value for pre-test of parallel trends assumption:  0.79239</span>

<span class="co"># plot them</span>
<span class="fu"><a href="../reference/ggdid.html">ggdid</a></span>(<span class="no">did.att.gt</span>)</pre></body></html></div>
<p><img src="pre-testing_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode"><html><body><pre class="r">
<span class="co"># aggregate them into event study plot</span>
<span class="no">did.es</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/aggte.html">aggte</a></span>(<span class="no">did.att.gt</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"dynamic"</span>)

<span class="co"># plot the event study</span>
<span class="fu"><a href="../reference/ggdid.html">ggdid</a></span>(<span class="no">did.es</span>)</pre></body></html></div>
<p><img src="pre-testing_files/figure-html/unnamed-chunk-5-2.png" width="700"></p>
<p>Overall, everything looks good using either approach. (Just to keep things fair, we report pointwise confidence intervals for group-time average treatment effects, but it is easy to get uniform confidence bands by adding the options <code>bstrap=TRUE, cband=TRUE</code> to the call to <code>att_gt</code>.)</p>
</div>
<div id="pitfall-selective-treatment-timing" class="section level4">
<h4 class="hasAnchor">
<a href="#pitfall-selective-treatment-timing" class="anchor"></a>Pitfall: Selective Treatment Timing</h4>
<p>Abraham and Sun (2018) point out a major limitation of event study regressions: when there is <strong>selective treatment timing</strong> the <span class="math inline">\(\mu_l\)</span> end up being weighted averages of treatment effects <em>across different lengths of exposures</em>.</p>
<p><strong>Selective treatment timing</strong> means that individuals in different groups experience systematically different effects of participating in the treatment from individuals in other groups. For example, there would be selective treatment timing if individuals choose to be treated in earlier periods if they tend to experience larger benefits from participating in the treatment. This sort of selective treatment timing is likely to be present in many applications in economics / policy evaluation.</p>
<p>Contrary to event study regressions, pre-tests based on group-time average treatment effects (or based on group-time average treatment effects that are aggregated into an event study plot) <strong>are still valid even in the presence of selective treatment timing</strong>.</p>
<p>To see this in action, let’s keep the same example as before, but add selective treatment timing.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># generate dataset with 4 time periods</span>
<span class="no">time.periods</span> <span class="kw">&lt;-</span> <span class="fl">4</span>

<span class="co"># generate dynamic effects</span>
<span class="no">te.e</span> <span class="kw">&lt;-</span> <span class="no">time.periods</span>:<span class="fl">1</span>

<span class="co"># generate selective treatment timing</span>
<span class="co"># (*** this is what is different here ***)</span>
<span class="no">te.bet.ind</span> <span class="kw">&lt;-</span> <span class="no">time.periods</span>:<span class="fl">1</span> / (<span class="no">time.periods</span>/<span class="fl">2</span>)

<span class="co"># generate data set with these parameters</span>
<span class="co"># (main thing: it generates a dataset that satisfies</span>
<span class="co"># parallel trends in all periods...including pre-treatment)</span>
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu">build_sim_dataset</span>()</pre></body></html></div>
<div class="sourceCode"><html><body><pre class="r"># run through same code as in earlier example...omitted</pre></body></html></div>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># run event study regression</span>
<span class="co"># normalize effect to be 0 in pre-treatment period</span>
<span class="no">es</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plm/man/plm.html">plm</a></span>(<span class="no">Y</span> ~ <span class="no">Dtmin3</span> + <span class="no">Dtmin2</span> + <span class="no">Dt0</span> + <span class="no">Dt1</span> + <span class="no">Dt2</span>, <span class="kw">data</span><span class="kw">=</span><span class="no">data</span>, <span class="kw">model</span><span class="kw">=</span><span class="st">"within"</span>, <span class="kw">effect</span><span class="kw">=</span><span class="st">"twoways"</span>, <span class="kw">index</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"id"</span>,<span class="st">"period"</span>))

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">es</span>)
<span class="co">#&gt; Twoways effects Within Model</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; plm(formula = Y ~ Dtmin3 + Dtmin2 + Dt0 + Dt1 + Dt2, data = data, </span>
<span class="co">#&gt;     effect = "twoways", model = "within", index = c("id", "period"))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Balanced Panel: n = 6988, T = 4, N = 27952</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;       Min.    1st Qu.     Median    3rd Qu.       Max. </span>
<span class="co">#&gt; -10.158205  -0.751216   0.023376   0.805780  11.190180 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;        Estimate Std. Error t-value  Pr(&gt;|t|)    </span>
<span class="co">#&gt; Dtmin3 0.938180   0.071538 13.1144 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Dtmin2 0.424155   0.051047  8.3092 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Dt0    3.655215   0.044701 81.7695 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Dt1    3.199891   0.055563 57.5898 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Dt2    2.610583   0.078828 33.1173 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Total Sum of Squares:    79441</span>
<span class="co">#&gt; Residual Sum of Squares: 58052</span>
<span class="co">#&gt; R-Squared:      0.26925</span>
<span class="co">#&gt; Adj. R-Squared: 0.025329</span>
<span class="co">#&gt; F-statistic: 1544.28 on 5 and 20956 DF, p-value: &lt; 2.22e-16</span></pre></body></html></div>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># run through same code as before...omitted</span>

<span class="co"># new event study plot</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span><span class="kw">=</span><span class="no">cmat</span>, <span class="kw">mapping</span><span class="kw">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span><span class="kw">=</span><span class="no">coefs</span>, <span class="kw">x</span><span class="kw">=</span><span class="no">exposure</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">linetype</span><span class="kw">=</span><span class="st">"dashed"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">ymin</span><span class="kw">=</span>(<span class="no">coefs</span>-<span class="fl">1.96</span>*<span class="no">ses</span>), <span class="kw">ymax</span><span class="kw">=</span>(<span class="no">coefs</span>+<span class="fl">1.96</span>*<span class="no">ses</span>)), <span class="kw">width</span><span class="kw">=</span><span class="fl">0.2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">2</span>,<span class="fl">5</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</pre></body></html></div>
<p><img src="pre-testing_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>In contrast to the last case, it is clear that things have gone wrong here. <strong>Parallel trends holds in all time periods and for all groups here</strong>, but the event study regression incorrectly rejects that parallel trends holds – this is due to the selective treatment timing.</p>
<p>We can compare this to what happens using the <code>did</code> package:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># estimate group-group time average treatment effects</span>
<span class="no">did.att.gt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/att_gt.html">att_gt</a></span>(<span class="st">"Y"</span>, <span class="st">"period"</span>, <span class="st">"id"</span>, <span class="st">"G"</span>, <span class="kw">data</span><span class="kw">=</span><span class="no">data</span>, <span class="kw">printdetails</span><span class="kw">=</span><span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">did.att.gt</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Reference: Callaway, Brantly and Sant'Anna, Pedro.  "Difference-in-Differences with Multiple Time Periods." Working Paper &lt;https://ssrn.com/abstract=3148250&gt;, 2019. </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  group   time          att          se</span>
<span class="co">#&gt; ------  -----  -----------  ----------</span>
<span class="co">#&gt;      2      2    5.0029547   0.0870479</span>
<span class="co">#&gt;      2      3    4.0633505   0.1157049</span>
<span class="co">#&gt;      2      4    3.1104585   0.1485773</span>
<span class="co">#&gt;      3      2   -0.0275928   0.0494924</span>
<span class="co">#&gt;      3      3    3.9992880   0.1017755</span>
<span class="co">#&gt;      3      4    2.9554333   0.1279480</span>
<span class="co">#&gt;      4      2   -0.0420415   0.0517733</span>
<span class="co">#&gt;      4      3    0.0015543   0.0480569</span>
<span class="co">#&gt;      4      4    2.0334554   0.1375333</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; P-value for pre-test of parallel trends assumption:  0.79832</span>

<span class="co"># plot them</span>
<span class="fu"><a href="../reference/ggdid.html">ggdid</a></span>(<span class="no">did.att.gt</span>)</pre></body></html></div>
<p><img src="pre-testing_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode"><html><body><pre class="r">
<span class="co"># aggregate them into event study plot</span>
<span class="no">did.es</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/aggte.html">aggte</a></span>(<span class="no">did.att.gt</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"dynamic"</span>)

<span class="co"># plot the event study</span>
<span class="fu"><a href="../reference/ggdid.html">ggdid</a></span>(<span class="no">did.es</span>)</pre></body></html></div>
<p><img src="pre-testing_files/figure-html/unnamed-chunk-13-2.png" width="700"></p>
<p>This is the correct performance (up to aforementioned caveats about multiple hypothesis testing).</p>
</div>
</div>
</div>
<div id="conditional-moment-tests" class="section level2">
<h2 class="hasAnchor">
<a href="#conditional-moment-tests" class="anchor"></a>Conditional Moment Tests</h2>
<p>Another main use case for the <code>did</code> package is when the parallel trends assumptions holds after conditioning on some covariates. This is likely to be important in many applications. For example, to evaluate the effect of participating in a job training program on earnings, it is likely to important to condition on an individual’s education. This would be true if (i) the distribution of education is different for individuals that participate in job training relative to those that don’t (this is very likely to hold as people that participate in job training tend to have less education than those who do not), and (ii) if the path of earnings (absent participating in job training) depends on an individual’s education. See Heckman, Ichimura, and Todd (1998) and Abadie (2005) for more discussion.</p>
<p>Even when one includes covariates to estimate group-time average treatment effects, pre-tests based only on group-time average treatment effects can fail to detect some violations of the parallel trends assumption. To give an example, suppose that the only covariate is binary variable for an individual’s sex. Pre-tests based on group-time average treatment effects could fail to detect violations of the conditional parallel trends assumption in cases where it is violated in one direction for men and in the other direction for women.</p>
<p>The <code>did</code> package contains an additional pre-test for the conditional parallel trends assumption in the <code>conditional_did_pretest</code> function.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># not run yet</span>
<span class="fu">reset.sim</span>()
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1814</span>)
<span class="no">nt</span> <span class="kw">&lt;-</span> <span class="fl">1000</span>
<span class="no">nu</span> <span class="kw">&lt;-</span> <span class="fl">1000</span>
<span class="no">cdp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/conditional_did_pretest.html">conditional_did_pretest</a></span>(<span class="st">"Y"</span>, <span class="st">"period"</span>, <span class="st">"id"</span>, <span class="st">"G"</span>, <span class="kw">xformla</span><span class="kw">=</span>~<span class="no">X</span>, <span class="kw">data</span><span class="kw">=</span><span class="no">data</span>)
<span class="no">cdp</span></pre></body></html></div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<ul>
<li><p>Abadie, Alberto. “Semiparametric difference-in-differences estimators.” The Review of Economic Studies 72.1 (2005): 1-19.</p></li>
<li><p>Abraham, Sarah, and Liyang Sun. “Estimating dynamic treatment effects in event studies with heterogeneous treatment effects.” Available at SSRN 3158747 (2018).</p></li>
<li><p>Callaway, Brantly, and Pedro HC Sant’Anna. “Difference-in-differences with multiple time periods.” Available at SSRN 3148250 (2019).</p></li>
<li><p>Heckman, James J., Hidehiko Ichimura, and Petra Todd. “Matching as an econometric evaluation estimator.” The review of economic studies 65.2 (1998): 261-294.</p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Brantly Callaway, Pedro H.C. Sant'Anna.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
