<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Writing Extensions to the did Package â€¢ did</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Writing Extensions to the did Package" />
<meta property="og:description" content="did" />
<meta property="og:image" content="/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">did</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../articles/index.html">User Guides</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/bcallaway11/did/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>


<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Writing Extensions to the did Package</h1>
                        <h4 class="author">Brantly Callaway and Pedro H.C. Sant'Anna</h4>
            
            <h4 class="date">2020-11-09</h4>
      
      <small class="dont-index">Source: <a href='https://github.com/bcallaway11/did/blob/master/vignettes/extensions.Rmd'><code>vignettes/extensions.Rmd</code></a></small>
      <div class="hidden name"><code>extensions.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This vignette provides an example of extending the ideas of the <strong>did</strong> package to some other cases.</p>
<ul>
<li><p>We see the central idea of our approach to DID to be for researchers to carefully make the comparisons that they want to make. It can be tricky to operationalize this though. And our code does not come close to covering all possible cases where one would like to identification to hold under some type of parallel trends assumption.</p></li>
<li><p>In this vignette, we demonstrate how to do difference in differences when individuals anticipate participating in the treatment and potentially adjust their behavior before they participate.</p></li>
<li><p>This setup falls outside of the cases covered (at the moment) in the <strong>did</strong> package. But it is straightforward (and instructive) to extend the ideas of the <strong>did</strong> package to this case. This vignette's primary purpose is to show a simplified version of the coed in the <strong>did</strong> package that would be straightforward to borrow/modify for one-off applications DID applications that do not conform exactly to the expected setup in the <strong>did</strong> package. You will see that it's not too complicated!</p></li>
<li><p>For this vignette, there's some math. The notation may be self-explanatory, but see our <a href="multi-period-did.html">Introduction to DID with Multiple Time Periods</a> for precise explanations of the notation.</p></li>
</ul>
</div>
<div id="did-with-anticipation" class="section level2">
<h2>DID with Anticipation</h2>
<p>The example we give next is one where individuals <strong>anticipate</strong> participating in the treatment and adjust their behavior (or at least their outcomes change) before they actually participate in the treatment. This is a feature of many applications in economics -- for example, in labor applications such as job training or job displacement, individual's earnings often &quot;dip&quot; before they actually participate in the treatment. One solution to this is to impose that parallel trends holds, but adjust the periods over which it holds. One version of this is to make the assumption that</p>
<p><strong>Parallel Trends with Anticipation</strong> For all groups and time periods <span class="math display">\[
  E[Y_t(0) - Y_{g-2}(0) | G=g] = E[Y_t(0) - Y_{g-2}(0) | C=1] 
\]</span></p>
<p>In other words, the path of outcomes, in the absence of participating in the treatment, between periods <span class="math inline">\((g-2)\)</span> and <span class="math inline">\(t\)</span> is the same for individuals in group <span class="math inline">\(g\)</span> (which is not observed) as for untreated individuals (which is observed).</p>
<p>In this case, it is straightforward to show that <span class="math display">\[
  ATT(g,t) = E[Y_t - Y_{g-2} | G=g] - E[Y_t - Y_{g-2} | C=1]
\]</span></p>
<p>This is very similar to the main case covered in the <strong>did</strong> package (see discussion in our <a href="multi-period-did.html">Introduction to DID with Multiple Time Periods</a> vignette), except that the &quot;base period&quot; here is <span class="math inline">\((g-2)\)</span> (two periods before individuals in group <span class="math inline">\(g\)</span> become treated) rather than <span class="math inline">\((g-1)\)</span> (one period before individuals in group <span class="math inline">\(g\)</span> become treated) which is the setup used in the <strong>did</strong> package.</p>
<div id="computing-treatment-effects-under-did-with-anticipation" class="section level3">
<h3>Computing Treatment Effects under DID with Anticipation</h3>
<p>To start with, we want to point out that the important part for this vignette is not so much this particular application, but rather just to demonstrate how to write the code for this particular case.</p>
<ul>
<li><p>The code below should be instructive for extending these sorts of ideas to other cases that may show up in applications.</p></li>
<li><p>We'll write a simplified version of the code -- it will not be as fast as the code in the <strong>did</strong> package, but it will demonstrate that it is relatively straightforward to write the code for modified versions of our approach. [BTW, the code below is not too slow either, basically things will run with a few thousand observations in a couple minutes rather than a couple seconds.]</p></li>
</ul>
<p>To start with, we've constructed a dataset (called <code>data</code>) that has anticipation. All groups follow parallel trends (in the absence of treatment) except in the period immediately before treatment. In those periods, outcomes for individuals who participate in the treatment &quot;dip&quot; -- here, they decrease by 1 in the pre-treatment period. In post-treatment periods, the effect of participating in the treatment is equal to 1. This is simulated data, but it has features that would be common in, for example, an application evaluating the effect of a job training program.</p>
<p>Here is what the data looks like</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nrow</span>(data)
<span class="co">#&gt; [1] 35845</span>
<span class="kw">head</span>(data)
<span class="co">#&gt;       G          X id period         Y treat</span>
<span class="co">#&gt; 1     5 -2.5711394  1      1  5.565900     1</span>
<span class="co">#&gt; 8001  5 -2.5711394  1      2  7.918863     1</span>
<span class="co">#&gt; 16001 5 -2.5711394  1      3  8.000886     1</span>
<span class="co">#&gt; 24001 5 -2.5711394  1      4 -1.508886     1</span>
<span class="co">#&gt; 32001 5 -2.5711394  1      5 -0.726539     1</span>
<span class="co">#&gt; 3     3 -0.4217184  3      1  3.969935     1</span></code></pre></div>
<p>where <code>G</code> defines the period when an individual first becomes treated, <code>X</code> is a covariate but we'll ignore it (parallel trends holds in this example without having to condition on <code>X</code>), and <code>Y</code> is the outcome.</p>
<p>As a first step, we'll try estimating the effect of participating in the treatment (focus on dynamic effects as in an event study plot) while just ignoring the possibility of anticipation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># estimate group-time average treatment effects using att_gt method</span>
<span class="co"># (and ignoring pre-treatment &quot;dip&quot;)</span>
attgt.ignoredip &lt;-<span class="st"> </span><span class="kw">att_gt</span>(<span class="dt">yname=</span><span class="st">&quot;Y&quot;</span>,
                          <span class="dt">tname=</span><span class="st">&quot;period&quot;</span>,
                          <span class="dt">idname=</span><span class="st">&quot;id&quot;</span>,
                          <span class="dt">gname=</span><span class="st">&quot;G&quot;</span>,
                          <span class="dt">xformla=</span><span class="op">~</span><span class="dv">1</span>,
                          <span class="dt">data=</span>data,
                          )

<span class="co"># summarize the results</span>
<span class="kw">summary</span>(attgt.ignoredip)
<span class="co">#&gt; </span>
<span class="co">#&gt; Reference: Callaway, Brantly and Sant&#39;Anna, Pedro.  &quot;Difference-in-Differences with Multiple Time Periods.&quot; Working Paper &lt;https://ssrn.com/abstract=3148250&gt;, 2020. </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; | group| time|        att|        se|</span>
<span class="co">#&gt; |-----:|----:|----------:|---------:|</span>
<span class="co">#&gt; |     3|    2| -0.9840474| 0.0901121|</span>
<span class="co">#&gt; |     3|    3|  2.0519939| 0.0635264|</span>
<span class="co">#&gt; |     3|    4|  2.1805175| 0.0824595|</span>
<span class="co">#&gt; |     3|    5|  2.4488373| 0.1112059|</span>
<span class="co">#&gt; |     4|    2| -0.1272953| 0.0587539|</span>
<span class="co">#&gt; |     4|    3| -0.9144926| 0.1295746|</span>
<span class="co">#&gt; |     4|    4|  1.9835460| 0.0637979|</span>
<span class="co">#&gt; |     4|    5|  2.1649563| 0.0932022|</span>
<span class="co">#&gt; |     5|    2|  0.0353515| 0.0502533|</span>
<span class="co">#&gt; |     5|    3| -0.0522051| 0.0526079|</span>
<span class="co">#&gt; |     5|    4| -1.2875806| 0.1478053|</span>
<span class="co">#&gt; |     5|    5|  2.0866274| 0.0703485|</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; P-value for pre-test of parallel trends assumption:  0</span>

<span class="co"># make dynamic effects plot</span>
p &lt;-<span class="st"> </span><span class="kw">ggdid</span>(<span class="kw">aggte</span>(attgt.ignoredip, <span class="st">&quot;dynamic&quot;</span>))

<span class="co"># add actual treatment effects to the plot</span>
truth &lt;-<span class="st"> </span><span class="kw">cbind.data.frame</span>(<span class="dt">e=</span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">3</span>,<span class="dv">2</span>), <span class="dt">att.e=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))
p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="dt">data=</span>truth, <span class="kw">aes</span>(<span class="dt">x=</span>e, <span class="dt">y=</span>att.e), <span class="dt">inherit.aes=</span><span class="ot">FALSE</span>, <span class="dt">color=</span><span class="st">&quot;blue&quot;</span>)
p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">data=</span>truth, <span class="kw">aes</span>(<span class="dt">x=</span>e, <span class="dt">y=</span>att.e), <span class="dt">inherit.aes=</span><span class="ot">FALSE</span>, <span class="dt">color=</span><span class="st">&quot;blue&quot;</span>)
p</code></pre></div>
<p><img src="extensions_files/figure-html/unnamed-chunk-5-1.png" width="700" /></p>
<p>In the figure, the blue line is the &quot;truth&quot;. You can see that anticipation leads to two things. First, it leads to rejecting the parallel trends assumptions -- you can correctly visualize the anticipation effects here and this is quite helpful for understanding what is going on. Second, however, the anticipation effects feed into the treatment effect estimates. Here, we over-estimate the effect of participating in the treatment due to the anticipation. Also, note that this example is really simple, and it would be easy to come up with cases where the results were much more complicated by anticipation.</p>
<p>One last thing to point out here: it would be fairly easy to &quot;hack&quot; the code in the the <strong>did</strong> package to work with anticipation. We could just change the value for when units first become treated to be before anticipation starts (with this dataset, set <code>data$G &lt;- data$G - 1</code>.</p>
<p>Instead of doing that, next we want to write our own code for getting around anticipation. A few notes:</p>
<ul>
<li><p>The goal here is to write a simple version of the code -- it's possible to write faster code than what is given below, but there is a tradeoff between code running fast and the amount of time spent writing it. If we were writing a one-off project that had anticipation, this is how we'd do it. If we ever add this feature to the <strong>did</strong> package, on the other hand, we'll probably take the extra time to get it running faster.</p></li>
<li><p>The code below is not (too much) optimized for <code>R</code>. We have tried to write code that is easy to understand and (close to being) portable to another programming language without too much trouble.</p></li>
<li><p>Code below computes a dynamic effects estimator, but we could easily compute some other aggregation or look at group-time average treatment effects if that's what we wanted.</p></li>
</ul>
<p>Now to the code. We'll start by writing a function to compute group-time average treatment effects and dynamic effects given some dataset (we'll rely on the dataset having variables called <code>G</code>, <code>id</code>, <code>period</code>, and <code>Y</code>, but this would be easy to modify). This function is a simplified version of what's going on behind the scenes in the <strong>did</strong> package. The code in the package looks more complicated than this but mainly due to more error handling, handling more cases, and implementing a more complicated (though faster) bootstrap procedure. But this function captures the main features of the <strong>did</strong> package -- and its not that complicated!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">compute.attgt &lt;-<span class="st"> </span><span class="cf">function</span>(data) {
  <span class="co"># pick up all groups</span>
  groups &lt;-<span class="st"> </span><span class="kw">unique</span>(data<span class="op">$</span>G)

  <span class="co"># pick up all time periods</span>
  time.periods &lt;-<span class="st"> </span><span class="kw">unique</span>(data<span class="op">$</span>period)

  <span class="co"># sort the groups and drop the untreated group</span>
  groups &lt;-<span class="st"> </span><span class="kw">sort</span>(groups)[<span class="op">-</span><span class="dv">1</span>]

  <span class="co"># sort the time periods and drop the first two</span>
  <span class="co"># (can&#39;t compute treatment effects for these two</span>
  <span class="co"># periods with anticpation -- w/o anticipation</span>
  <span class="co"># we would just drop one period here)</span>
  time.periods &lt;-<span class="st"> </span><span class="kw">sort</span>(time.periods)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)]

  <span class="co"># drop last time period (because we don&#39;t know if</span>
  <span class="co"># these units are affected by anticipation or not</span>
  <span class="co"># and we are being very careful)</span>
  <span class="co"># (if you were worried about more than one anticipation</span>
  <span class="co"># period here, would need to drop more time periods</span>
  <span class="co"># from the end)</span>
  time.periods &lt;-<span class="st"> </span>time.periods[<span class="op">-</span><span class="kw">length</span>(time.periods)]

  <span class="co"># list to store all group-time average treatment effects</span>
  <span class="co"># that we calculate</span>
  attgt.list &lt;-<span class="st"> </span><span class="kw">list</span>()
  counter &lt;-<span class="st"> </span><span class="dv">1</span>

  <span class="co"># loop over all groups</span>
  <span class="cf">for</span> (g <span class="cf">in</span> groups) {

    <span class="co"># get the correct &quot;base&quot; period for this group</span>
    <span class="co"># (subtract 2 to avoid anticipation)</span>
    main.base.period &lt;-<span class="st"> </span>g<span class="dv">-2</span>
    
    <span class="co"># loop over all time periods</span>
    <span class="cf">for</span> (tp <span class="cf">in</span> time.periods) {

      <span class="co">#----------------------------------------------------</span>
      <span class="co"># if it&#39;s a pre-treatment time period (used for the</span>
      <span class="co"># pre-test, we need to adjust the base period)</span>

      <span class="co"># group not treated yet</span>
      <span class="cf">if</span> (tp <span class="op">&lt;</span><span class="st"> </span>g) {
        <span class="co"># move two periods before</span>
        base.period &lt;-<span class="st"> </span>tp<span class="dv">-2</span>
      } <span class="cf">else</span> {
        <span class="co"># this is a post-treatment period</span>
        base.period &lt;-<span class="st"> </span>main.base.period
      }
      <span class="co">#----------------------------------------------------</span>

      <span class="co">#----------------------------------------------------</span>
      <span class="co"># now, all we need to do is collect the right subset</span>
      <span class="co"># of the data and estimate a 2x2 DID</span>

      <span class="co"># get group g and untreated group</span>
      this.data &lt;-<span class="st"> </span><span class="kw">subset</span>(data, G<span class="op">==</span>g <span class="op">|</span><span class="st"> </span>G<span class="op">==</span><span class="dv">0</span>)

      <span class="co"># get current period and base period data</span>
      this.data &lt;-<span class="st"> </span><span class="kw">subset</span>(this.data, period<span class="op">==</span>tp <span class="op">|</span><span class="st"> </span>period<span class="op">==</span>base.period)

      <span class="co"># set up to compute 2x2 estimator</span>
      Ypost &lt;-<span class="st"> </span><span class="kw">subset</span>(this.data, period<span class="op">==</span>tp)<span class="op">$</span>Y
      Ypre &lt;-<span class="st"> </span><span class="kw">subset</span>(this.data, period<span class="op">==</span>base.period)<span class="op">$</span>Y

      <span class="co"># dummy variable being in group g</span>
      G &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">*</span>(<span class="kw">subset</span>(this.data, period<span class="op">==</span>tp)<span class="op">$</span>G <span class="op">==</span><span class="st"> </span>g)

      <span class="co"># compute 2x2 estimator using DRDID package</span>
      <span class="co"># (in this unconditional case, it would be straightforward</span>
      <span class="co"># to calculate the 2x2 att just using averages, but we</span>
      <span class="co"># like the DRDID package as it will work for more complicated</span>
      <span class="co"># cases as well)</span>
      attgt &lt;-<span class="st"> </span>DRDID<span class="op">::</span><span class="kw">reg_did_panel</span>(Ypost, Ypre, G, <span class="dt">covariates=</span><span class="ot">NULL</span>)<span class="op">$</span>ATT

      <span class="co"># save results</span>
      attgt.list[[counter]] &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">att=</span>attgt, <span class="dt">group=</span>g, <span class="dt">time.period=</span>tp)
      counter &lt;-<span class="st"> </span>counter<span class="op">+</span><span class="dv">1</span>
      <span class="co">#----------------------------------------------------</span>

    }
  }

  <span class="co">#-----------------------------------------------------------------------------</span>
  <span class="co"># aggregate into dynamic effects</span>
  
  <span class="co"># turn results into a data.frame</span>
  attgt.results &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind.data.frame&quot;</span>, attgt.list)

  <span class="co"># add event time to the results</span>
  attgt.results<span class="op">$</span>e &lt;-<span class="st"> </span>attgt.results<span class="op">$</span>time.period <span class="op">-</span><span class="st"> </span>attgt.results<span class="op">$</span>group
  
  <span class="co"># calculate relative sizes of each group</span>
  <span class="co"># (will be used as weights)</span>
  n.group &lt;-<span class="st"> </span><span class="kw">sapply</span>(groups, <span class="cf">function</span>(gg) <span class="kw">nrow</span>(<span class="kw">subset</span>(data, G<span class="op">==</span>gg)))
  <span class="co"># merge in group sizes</span>
  ngroup.mat &lt;-<span class="st"> </span><span class="kw">cbind</span>(groups, n.group)
  attgt.results &lt;-<span class="st"> </span><span class="kw">merge</span>(attgt.results, ngroup.mat, <span class="dt">by.x=</span><span class="st">&quot;group&quot;</span>, <span class="dt">by.y=</span><span class="st">&quot;groups&quot;</span>)

  <span class="co"># event times to calculate dynamic effects</span>
  eseq &lt;-<span class="st"> </span><span class="kw">unique</span>(attgt.results<span class="op">$</span>e) 
  eseq &lt;-<span class="st"> </span><span class="kw">sort</span>(eseq)

  <span class="co"># calculate average effects by event time</span>
  att.e &lt;-<span class="st"> </span><span class="kw">c</span>()
  counter &lt;-<span class="st"> </span><span class="dv">1</span>
  <span class="cf">for</span> (this.e <span class="cf">in</span> eseq) {
    <span class="co"># get subset of results at this event time</span>
    res.e &lt;-<span class="st"> </span><span class="kw">subset</span>(attgt.results, e<span class="op">==</span>this.e)

    <span class="co"># calculate weights by group size</span>
    res.e<span class="op">$</span>weight &lt;-<span class="st"> </span>res.e<span class="op">$</span>n.group <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(res.e<span class="op">$</span>n.group)

    <span class="co"># calculate dynamic effect as weighted average</span>
    att.e[counter] &lt;-<span class="st"> </span><span class="kw">sum</span>(res.e<span class="op">$</span>att<span class="op">*</span>res.e<span class="op">$</span>weight)

    <span class="co"># on to the next one</span>
    counter &lt;-<span class="st"> </span>counter<span class="op">+</span><span class="dv">1</span>
  }

  <span class="co"># store dynamic effects results</span>
  dyn.results &lt;-<span class="st"> </span><span class="kw">cbind.data.frame</span>(<span class="dt">e=</span>eseq, <span class="dt">att.e=</span>att.e)

  <span class="co"># return group-time average treatment effects and dynamic effects</span>
  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">attgt.results=</span>attgt.results[,<span class="kw">c</span>(<span class="st">&quot;group&quot;</span>,<span class="st">&quot;att&quot;</span>,<span class="st">&quot;time.period&quot;</span>)],
              <span class="dt">dyn.results=</span>dyn.results))
}</code></pre></div>
<p>Now, we have a function to compute group-time average treatment effects and dynamic effects. Let's use it on the data that we have</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">anticipation.results &lt;-<span class="st"> </span><span class="kw">compute.attgt</span>(data)
anticipation.results
<span class="co">#&gt; $attgt.results</span>
<span class="co">#&gt;   group         att time.period</span>
<span class="co">#&gt; 1     3  0.97543339           3</span>
<span class="co">#&gt; 2     3  0.96346986           4</span>
<span class="co">#&gt; 3     4 -0.95865145           3</span>
<span class="co">#&gt; 4     4  0.95671195           4</span>
<span class="co">#&gt; 5     5 -0.06652802           3</span>
<span class="co">#&gt; 6     5 -1.06107932           4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $dyn.results</span>
<span class="co">#&gt;    e       att.e</span>
<span class="co">#&gt; 1 -2 -0.06652802</span>
<span class="co">#&gt; 2 -1 -1.00963835</span>
<span class="co">#&gt; 3  0  0.96636984</span>
<span class="co">#&gt; 4  1  0.96346986</span></code></pre></div>
<p>Finally, let's compute some standard errors using the bootstrap; we'll just focus on the dynamic effects estimator</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># the number of bootstrap iterations</span>
biters &lt;-<span class="st"> </span><span class="dv">100</span>

<span class="co"># list to store bootstrap results</span>
boot.res &lt;-<span class="st"> </span><span class="kw">list</span>()

<span class="co"># loop for each bootstrap iteration</span>
<span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>biters) {
  <span class="co"># draw a bootstrap sample; here, we&#39;ll call an outside function</span>
  bdata &lt;-<span class="st"> </span>BMisc<span class="op">::</span><span class="kw">blockBootSample</span>(data, <span class="st">&quot;id&quot;</span>)

  <span class="co"># call our function for estimating dynamic effects on the</span>
  <span class="co"># bootstrapped data</span>
  boot.res[[b]] &lt;-<span class="st"> </span><span class="kw">compute.attgt</span>(bdata)<span class="op">$</span>dyn.results<span class="op">$</span>att.e
}

<span class="co"># use the bootstrapped results to compute standard errors</span>
boot.res &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">simplify2array</span>(boot.res))
boot.se &lt;-<span class="st"> </span><span class="kw">apply</span>(boot.res, <span class="dv">2</span>, sd)

<span class="co"># add the standard errors to the main results</span>
dyn.results &lt;-<span class="st"> </span>anticipation.results<span class="op">$</span>dyn.results
dyn.results<span class="op">$</span>att.se &lt;-<span class="st"> </span>boot.se</code></pre></div>
<p>Finally, we can translate these into a plot. [One last thing here, to keep things simple, we are going to plot pointwise confidence intervals, but we strongly suggest computing uniform confidence bands in practice.]</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>dyn.results, <span class="kw">aes</span>(<span class="dt">x=</span>e, <span class="dt">y=</span>att.e)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">ymin=</span>(att.e<span class="fl">-1.96</span><span class="op">*</span>att.se), <span class="dt">ymax=</span>(att.e<span class="fl">+1.96</span><span class="op">*</span>att.se)), <span class="dt">width=</span><span class="fl">0.1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()

p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="dt">data=</span>truth, <span class="kw">aes</span>(<span class="dt">x=</span>e, <span class="dt">y=</span>att.e), <span class="dt">inherit.aes=</span><span class="ot">FALSE</span>, <span class="dt">color=</span><span class="st">&quot;blue&quot;</span>)
p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">data=</span>truth, <span class="kw">aes</span>(<span class="dt">x=</span>e, <span class="dt">y=</span>att.e), <span class="dt">inherit.aes=</span><span class="ot">FALSE</span>, <span class="dt">color=</span><span class="st">&quot;blue&quot;</span>)
p</code></pre></div>
<p><img src="extensions_files/figure-html/unnamed-chunk-7-1.png" width="700" /></p>
<p>Here, the black line is our estimate and the blue line is the &quot;truth&quot;. You can immediately see that we get things right here when we account for anticipation. The only other thing to notice is that we do not estimate dynamic effects at as many different lengths of exposure, but that is the price to pay for accounting for anticipation.</p>
</div>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
<p>In this vignette, we showed how to extend the ideas of the <strong>did</strong> package to account for anticipation effects. This is a relatively straightforward extension, and we think that showing this sort of extension is potentially useful for other situations that do not fit exactly into the cases covered by the <strong>did</strong> package.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc">
      <h2 data-toc-skip>Contents</h2>
    </nav>
      </div>

</div>



      <footer>
      <div class="copyright">
  <p>Developed by Brantly Callaway, Pedro H.C. Sant'Anna.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>

